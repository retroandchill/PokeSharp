#nullable enable
using PokeSharp.Core.Strings;
using PokeSharp.Editor.Core.PokeEdit.Requests;
using PokeSharp.Editor.Core.PokeEdit.Serialization;

namespace {{Namespace}};

public sealed class {{ClassName}}({{ServiceClass}} service, IPokeEditSerializer serializer) : IRequestHandler
{
    private static readonly Name RequestName = "{{RequestName}}";
    public Name Name => RequestName;
    
    public void Process(Stream requestStream, Stream responseStream)
    {
        {{#HasRequestBody}}
        var request = serializer.Deserialize<{{RequestType}}>(requestStream);
        {{#RequestTypeNotNull}}
        if (request is null) throw new InvalidOperationException("Request body was null");
        {{/RequestTypeNotNull}}
        {{/HasRequestBody}}
        {{#HasResponseBody}}var response = {{/HasResponseBody}}service.{{MethodName}}({{#HasRequestBody}}request{{/HasRequestBody}});
        {{#HasResponseBody}}
        {{#ResponseNotNull}}
        if (response is null) throw new InvalidOperationException("Response was null");    
        {{/ResponseNotNull}}
        serializer.Serialize(responseStream, response);
        {{/HasResponseBody}}
        {{^HasResponseBody}}
        using var streamWriter = new StreamWriter(responseStream);
        streamWriter.WriteAsync("{}");
        {{/HasResponseBody}}
    }

    public async ValueTask ProcessAsync(Stream requestStream, Stream responseStream, CancellationToken cancellationToken = default)
    {
        {{#HasRequestBody}}
        var request = await serializer.DeserializeAsync<{{RequestType}}>(requestStream, cancellationToken);
        {{#RequestTypeNotNull}}
        if (request is null) throw new InvalidOperationException("Request body was null");
        {{/RequestTypeNotNull}}
        {{/HasRequestBody}}
        {{#HasResponseBody}}var response = {{/HasResponseBody}}await service.{{MethodName}}Async({{#HasRequestBody}}request{{/HasRequestBody}}{{#HasCancellationToken}}{{#HasRequestBody}}, {{/HasRequestBody}}cancellationToken{{/HasCancellationToken}});
        {{#HasResponseBody}}
        {{#ResponseNotNull}}
        if (response is null) throw new InvalidOperationException("Response was null");    
        {{/ResponseNotNull}}
        await serializer.SerializeAsync(responseStream, response, cancellationToken);
        {{/HasResponseBody}}
        {{^HasResponseBody}}
        await using var streamWriter = new StreamWriter(responseStream);
        await streamWriter.WriteAsync("{}", cancellationToken);
        {{/HasResponseBody}}
    }
}